<% url = OsPhoneBook::Application.routes.url_helpers %>

function focusNextField(id) {
    var element = $(id);
    var form = element.form;
    var next_id = 0;
    for (var i = 0; i < form.elements.length; i++) {
        if (form.elements[i] == element) {
            next_id = i + 1;
        }
    }
    var next_element = form.elements[next_id];
    if (next_element) {
        next_element.focus();
    }
}

function remove_tag(container) {
    $(container).up(".tag").remove();
}

function updateFormTags(newTag) {
  new $.ajax({
    url: '<%= url.set_tags_path %>',
    data: {
      add_tag: newTag,
      'tags[]': $(".tag input[type='hidden']").map(function(){return this.value}).get()
    },
    success: function (responseText) {
      $('#tags').append(responseText);
      $('#add_tag').value = "";
    }
  });

  return false;
}

$(document).ready(function() {
  $('#company_search_field').autocomplete({
    source: '<%= url.company_search_path %>',
    minLength: 1,
    maxHeight: 400,
    width: 390,
    delay: 200,
    select: function(value, data) {
      $('#company_search_field').value = data;
      focusNextField('#company_search_field');
    }
  });

  $('#add_tag').autocomplete({
    source: '<%= url.tag_search_path %>',
    minLength: 1,
    maxHeight: 400,
    width: 390,
    delay: 200,
    onSelect: function(value, data) {
      $('#add_tag').value = "";
      updateFormTags(data);
    }
  });

  $('#company_search_field').keypress(function(e) {
    if (e.key == "Enter") {
      e.stop();
    }
  });

  $('#add_tag').keypress(function(e) {
    if (e.key == "Enter") {
      e.stop();
    }
  });

  if ($("#contact_name").length && $("#contact_name")[0].value.length > 0) {
    $("#company_search_field").focus();
  } else {
    $("#contact_name").focus();
  }
});
